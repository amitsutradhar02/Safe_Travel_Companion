{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="card-title">{{ group.name }}</h2>
                    <p><strong>Destination:</strong> {{ group.destination }}</p>
                    <p><strong>Departure Time:</strong> {{ group.departure_time.strftime('%Y-%m-%d %H:%M') }}</p>
                    <a href="{{ url_for('group_detail', group_id=group.id) }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Group
                    </a>
                </div>
            </div>

            <!-- Map Section -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Route to Destination</h5>
                    <div id="map" style="height: 600px; width: 100%;"></div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Route Information -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Route Information</h5>
                    <div id="route-info">
                        <p><strong>Distance:</strong> <span id="distance">Calculating...</span></p>
                        <p><strong>Duration:</strong> <span id="duration">Calculating...</span></p>
                    </div>
                </div>
            </div>

            <!-- Alternative Routes -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Alternative Routes</h5>
                    <div id="alternatives" class="list-group">
                        <!-- Alternative routes will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places,directions"></script>
<script>
let map;
let directionsService;
let directionsRenderer;
let currentRoute = 0;
let routes = [];

function initMap() {
    // Initialize the map
    map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: parseFloat("{{ group.latitude }}"), lng: parseFloat("{{ group.longitude }}") },
        zoom: 13
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        panel: document.getElementById('alternatives')
    });

    // Get user's current location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
            const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            // Calculate route
            calculateRoute(userLocation, {
                lat: parseFloat("{{ group.latitude }}"),
                lng: parseFloat("{{ group.longitude }}")
            });

            // Add markers for start and end points
            new google.maps.Marker({
                position: userLocation,
                map: map,
                title: 'Your Location',
                icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 10,
                fillColor: '#4285F4',
                fillOpacity: 1,
                strokeColor: '#ffffff',
                strokeWeight: 2,
                }
            });

            new google.maps.Marker({
                position: { lat: parseFloat("{{ group.latitude }}"), lng: parseFloat("{{ group.longitude }}") },
                map: map,
                title: '{{ group.destination }}'
            });
            },
            (error) => {
            console.error('Error getting location:', error);
            // If geolocation fails, just show the destination
            new google.maps.Marker({
                position: { lat: parseFloat("{{ group.latitude }}"), lng: parseFloat("{{ group.longitude }}") },
                map: map,
                title: '{{ group.destination }}'
            });
            }
        );
    }
}

function calculateRoute(origin, destination) {
    const request = {
        origin: origin,
        destination: destination,
        travelMode: 'DRIVING',
        provideRouteAlternatives: true
    };

    directionsService.route(request, function(result, status) {
        if (status == 'OK') {
            routes = result.routes;
            directionsRenderer.setDirections(result);
            
            // Update route information
            updateRouteInfo(routes[0]);
            
            // Add alternative routes to the panel
            const alternativesDiv = document.getElementById('alternatives');
            alternativesDiv.innerHTML = '';
            
            routes.forEach((route, index) => {
                const leg = route.legs[0];
                const button = document.createElement('button');
                button.className = 'list-group-item list-group-item-action';
                button.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Route ${index + 1}</strong><br>
                            <small>${leg.distance.text} - ${leg.duration.text}</small>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="showRoute(${index})">Show</button>
                    </div>
                `;
                alternativesDiv.appendChild(button);
            });
        } else {
            console.error('Directions request failed:', status);
        }
    });
}

function updateRouteInfo(route) {
    const leg = route.legs[0];
    document.getElementById('distance').textContent = leg.distance.text;
    document.getElementById('duration').textContent = leg.duration.text;
}

function showRoute(index) {
    if (routes[index]) {
        directionsRenderer.setDirections({
            routes: [routes[index]]
        });
        updateRouteInfo(routes[index]);
    }
}

// Initialize the map when the page loads
window.onload = initMap;
</script>
{% endblock %} 